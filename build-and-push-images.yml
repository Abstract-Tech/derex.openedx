steps:

  - script: docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}
    displayName: 'Log into docker registry'
    env:
      DOCKER_USERNAME: $(DOCKER_USERNAME)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)

  - script: ${DOCKER_COMMAND} --build-arg BUILDKIT_INLINE_CACHE=1 -t derex/edx-${DOCKER_IMAGES_SLUG}-libgeos --target libgeos docker-definition/
    displayName: Build libgeos image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-libgeos
    displayName: Push libgeos

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-base --target base docker-definition/
    displayName: Build base image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-base
    displayName: Push base

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-sourceonly --target sourceonly docker-definition/
    displayName: Build sourceonly image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-sourceonly
    displayName: Push sourceonly

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-wheels --target wheels docker-definition/
    displayName: Build wheels image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-wheels
    displayName: Push wheels

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-nostatic --target nostatic docker-definition/
    displayName: Build nostatic image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-nostatic
    displayName: Push nostatic

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-nostatic-dev --target nostatic-dev docker-definition/
    displayName: Build nostatic-dev image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-nostatic-dev
    displayName: Push nostatic-dev

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-dev-nodump --target dev-nodump docker-definition/
    displayName: Build dev-nodump image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dev-nodump
    displayName: Push dev-nodump

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-dump --target dump docker-definition/
    displayName: Build dump image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dump
    displayName: Push dump

  # No caching here: the previous one is enough, and it seems to stall for some reason
  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} -t derex/edx-${DOCKER_IMAGES_SLUG}-dev --target dev docker-definition/
    displayName: Build dev image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dev
    displayName: Push dev
