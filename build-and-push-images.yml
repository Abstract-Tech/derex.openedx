steps:
  # Build/restore the BuildKit tool
  - task: Cache@2
    inputs:
      key: $(CACHE_KEY_BUILDKIT)
      path: '$(System.DefaultWorkingDirectory)/buildkit'
      cacheHitVar: 'BuildKitToolHit'
    displayName: 'cache buildkit tool'

  - script: |
      git clone https://github.com/moby/buildkit.git  --branch $(BUILDKIT_COMMIT) --depth 1
      cd buildkit
      make
    displayName: "Build BuildKit on cache miss"
    condition: and(succeeded(), ne(variables['BuildKitToolHit'], 'true'))

  - script: |
      cd buildkit
      sudo make install
      which buildctl
      which buildkitd
      set -e -x
      sudo nohup buildkitd --debug --root /var/lib/buildkit &
      sudo chown -R ${USER} /run/buildkit/ || true
      until sudo buildctl du -v
      do
        sudo chown -R ${USER} /run/buildkit/ || true
        echo "Waiting for daemon to load"
        sleep 1
      done
      mkdir ${LAYERS_CACHE_DIR}
    displayName: "Install and start buildkit"


  # restore the BuildKit cache based on the Dockerfile ...
  - task: Cache@2
    inputs:
      key: $(CACHE_KEY_EXACT)
      path: '$(LAYERS_CACHE_DIR)'
      cacheHitVar: 'BuildKitLayersHit'
      restoreKeys: $(CACHE_KEY_FALLBACK)
    displayName: 'Docker layers cache'

  - script: |
      if [ -d "$(LAYERS_CACHE_DIR)" ]; then
        echo "Will use cached layers from $(LAYERS_CACHE_DIR)"
        find $(LAYERS_CACHE_DIR)
        DOCKER_COMMAND="$DOCKER_COMMAND --import-cache type=local,src=$(LAYERS_CACHE_DIR)"
      fi
      if [ "$(BuildKitLayersHit)" != "true" ]; then
        echo "Will store cached layers to $(LAYERS_CACHE_DIR)"
        DOCKER_COMMAND="$DOCKER_COMMAND --export-cache mode=max,type=local,dest=$(LAYERS_CACHE_DIR)"
      fi
      echo  "##vso[task.setvariable variable=DOCKER_COMMAND]${DOCKER_COMMAND}"
    displayName: 'Setup docker layers cache'

  - script: docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}
    displayName: 'Log into docker registry'
    env:
      DOCKER_USERNAME: $(DOCKER_USERNAME)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)

  - script: set -ex; ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-libgeos,push=true --opt target=libgeos
    displayName: Build libgeos image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-libgeos
    displayName: Push libgeos

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-base,push=true --opt target=base
    displayName: Build base image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-base
    displayName: Push base

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-sourceonly,push=true --opt target=sourceonly
    displayName: Build sourceonly image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-sourceonly
    displayName: Push sourceonly

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-wheels,push=true --opt target=wheels
    displayName: Build wheels image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-wheels
    displayName: Push wheels

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-nostatic,push=true --opt target=nostatic
    displayName: Build nostatic image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-nostatic
    displayName: Push nostatic

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-nostatic-dev,push=true --opt target=nostatic-dev
    displayName: Build nostatic-dev image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-nostatic-dev
    displayName: Push nostatic-dev

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-dev-nodump,push=true --opt target=dev-nodump
    displayName: Build dev-nodump image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dev-nodump
    displayName: Push dev-nodump

  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-dump,push=true --opt target=dump
    displayName: Build dump image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dump
    displayName: Push dump

  # No caching here: the previous one is enough, and it seems to stall for some reason
  - script: ${DOCKER_COMMAND} ${DOCKER_OPTS} --output type=image,name=docker.io/derex/edx-${DOCKER_IMAGES_SLUG}-dev,push=true --opt target=dev
    displayName: Build dev image

  - script: docker push derex/edx-${DOCKER_IMAGES_SLUG}-dev
    displayName: Push dev
